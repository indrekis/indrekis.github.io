---
layout: post
title:  "Коротка інструкція до CP/M"
date:   2023-07-17 1:23:45 +0300
tags: [CP/M, retrocomputing]
categories: [retrocomputing, CP/M]
comments: true
excerpt_separator: <!--more-->
---

- [Огляд]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#огляд)
- [Файлова система з точки зору користувача]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#файлова-система-з-точки-зору-користувача)
- [Вбудовані команди]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#вбудовані-команди)
- [Стандартні транзієнтні команди]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#стандартні-транзієнтні-команди)
  - [DIR.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#dircom)
  - [DEVICE.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#devicecom)
  - [PIP.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#pipcom)
  - [DDT.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#ddtcom)
  - [SID.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#sidcom)
  - [ED.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#edcom)
  - [STAT.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#statcom)
  - [COPYSYS.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#copysyscom)
  - [DATE.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#datecom)
  - [DUMP.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#dumpcom)
  - [GET.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#getcom)
  - [INITDIR.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#initdircom)
  - [PUT.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#putcom)
  - [SET.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#setcom)
  - [SHOW.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#showcom)
  - [SUBMIT.COM]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#submitcom)
  - [PROFILE.SUB]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#profilesub)
- [Виноски]({% post_url /retrocomputing/cpm/2023-07-17-cpm_manual1 %}#виноски)

Книжок по CP/M[^0] було багато -- навіть в документації до [Osborne-ів](/retrocomputing/cpm/files/3F00186-00_ExecutiveRef_1983.pdf) є детальна інструкція, тому тут лише коротка ''шпаргалка''.

<!--more-->

<style>body {text-align: justify}</style>

# Огляд 

CP/M складається з трьох частин:

- Basic Input/Output System (**BIOS**),
- Basic Disk Operating System (**BDOS**),
- Console Command Processor (**CCP**).

BIOS i BDOS резидентні, CCP може бути затертим прикладною програмою. Детальніше див. [CP/M Internals](https://obsolescence.wixsite.com/obsolescence/cpm-internals).

![](/retrocomputing/cpm/pics/cpm_memmap.png){: .align-center}

Зовнішні програми називаються **транзієнтними**, мають розширення .COM. В коді вважається, що їх завантажують за адресою 0x100 та передають керування безпосередньо -- виконавчі файли не мають якоїсь структури, на відміну від більш просунутих ОС[^1]. 

# Файлова система з точки зору користувача

Оперує дисками: A:, B:, C: тощо. Директорії не підтримуються, але підтримуються користувачі, яким  належить кожен файл. Задаються номерами від 0 до 15. Якщо обрати користувача (командою USER n), за замовчуванням будуть видимі лише його файли -- такий собі примітивний спосіб організувати файли.

Імена файлів 8+3, як і в DOS, регістр літер не має значення, а фізично імена зберігаються великими літерами. Літера та цифри дозволені, '``$``', '``+``', '``-``' тощо -- іноді, але '`` ``', '``=``', '``;``', '``:``', '``.``', '``*``', '``?``', '``>``', '``<``', '``_``', '``[``', '``]``', '``(``', '``)``', '``/``', '``\``', '``|``', '``%``'  [заборонені](https://www.seasip.info/Cpm/optchar.html), оскільки мають спеціальне значення як не для CCP то для PIP -- але є певна неузгодженість, наприклад, створити файл із символом  '/' в імені можна, і частина програм нормально з ним працювати.

Час модифікації може зберігатися лише на нових версіях CP/M. Розмір зберігається лише як кількість блоків, розміром 128 байт, тому кінець файлу відзначається символом 0x1A десь в останньому блоці[^3].

Підтримує захист файлу паролем, але цей захист чисто символічний.

# Вбудовані команди

Вбудовані -- команди, реалізовані CCP. Часто існують у двох варіантах: простіший, реалізований CPP, і окрема транзієнтна утиліта із ширшими можливостями. Приклад -- DIR i DIR.COM. Вбудовані команди детектують деякі ситуації, коли потрібна зовнішня аналогічна утиліта (наприклад, передано опції команді DIR) і викликають її, а якщо не знайдено -- виводять щось типу ``DIR     COM required``.

Оскільки утиліти CP/M часто використовують квадратні дужки, [ та ] в опціях, позначення дещо відрізняються від стандартних -- опціональні аргументи позначаю фігурними дужками, але, типово, вертикальною рискою розділено різні варіанти.

Команди можна скорочувати -- ERASE можна писати як ERA, ERAS, ERASE. 

Деякі команди, якщо не передати аргументи, запитують їх інтерактивно.

- ``DIR {wildcard|filename}`` -- вивести список файлів. Системні -- не показує.
  - ``DIRSYS`` -- вивести лише системні файли.
- ``ERA filename|wildcard`` -- стерти файл. Повне ім'я команди -- ERASE. 
- ``REN  newfilename|wildcard=oldfilename|wildcard`` -- перейменувати файл. Повне ім'я -- RENAME. Якщо не передати аргумент -- запитується інтерактивно.
- ``TYPE filename|wildcard`` -- вивести на консоль. 
- ``USER usern`` -- обрати користувача з номером usern, від 0 до 15.
- ``SAVE pages filename`` -- зберегти у файл filename кількість pages сторінок із пам'яті, розміром 256 байт, починаючи з адреси 0x100 = 256. Спрацьовує при виході із програми, запущеної зразу після.

# Стандартні транзієнтні команди

Виконавчі файли мають розширення .COM, але вказувати його не обов'язково.

Не всі команди будуть доступні для CPM 2.2, що йде з Osborne 1.

## DIR.COM

Виводить помітно детальнішу інформацію, ніж вбудована DIR.

| ![](/retrocomputing/cpm/pics/cpm_dir_com_1.png){: .align-center}  |
|:------------------------------:|
| Приклад виводу DIR.COM. Видно, що розмір файлу в полі ``Bytes`` вказується кратним фізичним секторам, які для Osborne Executive, за замовчуванням -- 1Кб, навіть для T.TXT, у якому десяток літер, а Recs -- в записах по 128 байт.|

| ![](/retrocomputing/cpm/pics/cpm_dir_1.png){: .align-center} |
|:------------------------------:|
| Вивід вбудованої DIR для того ж диску, що й на попередній картинці.|

Приймає ряд опцій у квадратних дужках, наприклад: ``DIR [DRIVER=(A,B)]`` -- вивести файли на дисках A i B. Якщо ``DIR`` передати опції, вона автоматично шукатиме DIR.COM.

Деякі опції:

- [ATT] -- вивести всі атрибути файлу.
- [DATE] -- вивести дати файлів, або повідомити, що їх підтримка не активована.
- [DRIVE=ALL] -- вивести файли на всіх дисках.
- [DRIVER=(A,B)] -- вивести файли на переданих дисках.
- [FULL] -- вивести детальну інформацію про файли.
- [NOPAGE] -- не зупинятися після заповнення сторінки.
- [NOSORT] -- не сортувати вивід.
- [RO]/[RW] -- показувати лише read-only/read-write файли.
- [SIZE] -- показувати розмір.
- [USER=ALL]/[USER=n] -- показувати файли всіх користувачів, або для вказаного користувача.

| ![](/retrocomputing/cpm/pics/cpm_dir_2.png){: .align-center} |
|:------------------------------:|
| Приклад виводу команди ``DIR a: [FULL]``.|

Ремарка: підтримуються "CP/M Plus" -- CP/M 3, але не підтримуються CP/M 2.2, тому (поки?) не працюватимуть в [RunCPM]({% post_url /retrocomputing/cpm/2023-07-14-cpm_emu_runcpm %}).

## DEVICE.COM

Виводить відповідність фізичних та логічних пристроїв.

![](/retrocomputing/cpm/pics/cpm_device_com_1.png){: .align-center}

## PIP.COM

Копіювати файли: ``pip dest=src``. Приклади: 

- ``PIP A:=B:*.COM`` -- копіювати всі COM-файли з диску B: на диск A:.
- ``PIP A:=B:FILE1.TXT,FILE1.OVR`` -- скопіювати два файли.
- ``PIP B:NEWNAME.TXT=B:OLDNAME.TXT`` -- створити копію файлу з іншим іменем.
- ``PIP COMB.TXT=PART1.TXT,PART2.TXT,PART3.TXT`` -- об'єднати три файли з поточного диску в COMB.TXT.
- ``PIP B:[G1]=A:*.BAS`` -- скопіювати всі файли з розширенням .BAS поточного користувача для  користувача з номером 1 диску B:.

Назви спеціальних пристроїв:

- AUX:
- CON:
- PRN:
- LST:
- NUL:
- EOF:

Наприклад:

- відправити файл на друк: ``PIP PRN:=FILE.TXT``,
- безпосередньо друкувати з консолі:  ``PIP PRN:=CON:``,
  - Ctrl-Z припиняє копіювання, якщо ввід відбувається з консолі.

Найпростіший спосіб створити файл: ``PIP NEW.TXT=CON:``. Мені певне бракує знань, але RETRUN лише переводить курсор на початок, і нові літери вводяться поверх старих. Вдалося ввести більше одного рядка, використовуючи Ctrl-M для створення нового рядка і RETURN для переходу на початок. Ймовірно, воно працює як пара CR-LF.

## DDT.COM

Dynamic Debugging Tool -- інтерактивний дебагер із CP/M 2.x. Див., наприклад, [тут](http://www.primrosebank.net/computers/cpm/cpm_ddt.htm). 

## SID.COM

Symbol Debugger -- більш просунутий дебагер. Див., наприклад, [тут](http://www.cpm.z80.de/randyfiles/DRI/SID_ZSID.pdf).

І DDT i SID приємно здивували, враховуючи епоху.

## ED.COM

Вбудований ''рядковий'' редактор. Не для слабких духом, тому я витратив час на портування [TE].
<!-- TODO: fix links whed done -->

## STAT.COM 

Виводить інформацію про послідовні та паралельні порти, диски і файли. Застаріла в CP/M 3.0, її функцію виконує DIR.COM та SHOW.COM.

## COPYSYS.COM

Копіює ОС на дискету.

## DATE.COM

Встановити або подивитися (''DATE SET``) дату та час.

## DUMP.COM

Вивести вміст файлу як HEX.

## GET.COM 

Дозволяє наступній команді отримувати ввід з файлу, замість із консолі -- таке собі мінімалістичне перенаправлення. Опція [SYSTEM] вказує зразу читати з файлу, а без неї -- одну команду можна ввести з консолі. Файл, який використовується для вводу, може вказати брати ввід з консолі: ``GET CONSOLE``.

![](/retrocomputing/cpm/pics/cpm_get_com_1.png){: .align-center}

## INITDIR.COM

Підготувати диск до збереження дати модифікації файлів.

## PUT.COM 

Дзеркальна до GET.COM -- перенаправляє вивід на консоль чи принтер, у файл.

## SET.COM

- Вмикає-вимикає паролі.
- Керує, зберігати час та дату створення, зміни чи доступу до файлів.
- Присвоює імена дискам.
- Керує атрибутиами файлів -- архівним, RO/RW, системним, DIR та користувацькими[^2].

## SHOW.COM

Показує режим доступу (RW/RO) до диску, доступне місце тощо.
- ``SHOW`` 
- ``SHOW a:[DIR]``
- ``SHOW b:[USERS]``
- ``SHOW b:[DRIVE]``
- ``SHOW b:[LABEL]``

![](/retrocomputing/cpm/pics/cpm_show_com_1.png){: .align-center}

## SUBMIT.COM

Дозволяє виконати команди із .SUB файлу -- примітивна можливість створювати скрипти.

![](/retrocomputing/cpm/pics/cpm_submit_1.png){: .align-center}

Можна передавати аргументи, доступні із скрипта за іменами ``$1``, ``$2``, ..., ``$9``.

Якщо команда потребує інтерактивного вводу, його, після неї, можна передати за допомогою символа <:

```bash
PIP
<B:=*.ASM
<B:=*.HEX
<
```

Символ < без інших літер -- ввести Return, PIP.COM на цьому завершує. Якщо вводу замало -- чекатиме з клавіатури, якщо забагато -- проігнорує, вивівши попередження.

Спецсимволи виду Ctrl-@ можна вводити як ^@.

## PROFILE.SUB

Цей файл виконується при старті -- аналог AUTOEXEC.BAT з DOS.


# Виноски

[^0]:  Control Program/Monitor або Control Program for Microcomputers.

[^1]: Хоча CP/M-3.0 додала Resident System Extensions, RSE, зі своїм форматом. Але, все рівно, перший байт таких виконавчих файлів містив команду RET -- щоб не ''зламатися'' на версіях ОС, які про них не знають.

[^2]: Цікаво, що атрибути файлова система зберігає в старших бітах імен файлів -- оскільки самі дозволені коди літер завжди семибітні.

[^3]: І наслідки цього ми досі відчуваємо у Windows...